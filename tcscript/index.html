<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tcScript - TrussC Playground</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #252526;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3c3c3c;
            height: 48px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 500;
            color: #cccccc;
        }

        .header h1 span {
            color: #569cd6;
        }

        .controls {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s;
        }

        .btn-run {
            background: #0e639c;
            color: white;
        }

        .btn-run:hover {
            background: #1177bb;
        }

        .btn-stop {
            background: #5a5a5a;
            color: white;
        }

        .btn-stop:hover {
            background: #6a6a6a;
        }

        .main {
            display: flex;
            height: calc(100vh - 48px);
        }

        .editor-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
        }

        #editor {
            flex: 1;
            width: 100%;
        }

        .canvas-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #canvas {
            outline: none;
        }

        #canvas:focus {
            outline: none;
        }

        .console {
            height: 240px;
            background: #1e1e1e;
            border-top: 1px solid #3c3c3c;
            overflow-y: auto;
            padding: 8px;
            font-size: 12px;
        }

        .resizer {
            width: 6px;
            background: #3c3c3c;
            cursor: col-resize;
            transition: background 0.2s;
        }

        .resizer:hover,
        .resizer.active {
            background: #007acc;
        }

        .resizer-h {
            height: 6px;
            background: #3c3c3c;
            cursor: row-resize;
            transition: background 0.2s;
        }

        .resizer-h:hover,
        .resizer-h.active {
            background: #007acc;
        }

        .console-line {
            margin: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .console-line.error {
            color: #f14c4c;
        }

        .console-line.notice {
            color: #3794ff;
        }

        .console-line.success {
            color: #89d185;
        }

        .status {
            padding: 4px 16px;
            background: #007acc;
            color: white;
            font-size: 12px;
        }

        .status.error {
            background: #f14c4c;
        }

        .status.ready {
            background: #89d185;
            color: #1e1e1e;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
        }

        .loading-spinner {
            border: 3px solid #3c3c3c;
            border-top: 3px solid #007acc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="header">
        <h1>tc<span>Script</span> - TrussC Playground</h1>
        <div class="controls">
            <button class="btn btn-run" id="runBtn" onclick="runScript()">Run</button>
            <button class="btn btn-stop" onclick="saveScript()">Save</button>
            <button class="btn btn-stop" onclick="loadScript()">Load</button>
            <button class="btn btn-stop" onclick="shareScript()">Share</button>
            <button class="btn btn-stop" onclick="toggleFullscreen()">Fullscreen</button>
        </div>
    </div>

    <div class="main">
        <div class="editor-panel" id="editorPanel">
            <div id="editor"></div>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="canvas-panel" id="canvasPanel">
            <div class="status" id="status">Loading...</div>
            <div class="canvas-container" id="canvasContainer">
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading tcScript engine...</span>
                </div>
                <canvas id="canvas" tabindex="-1" style="display:none; width:600px; height:600px;"></canvas>
            </div>
            <div class="resizer-h" id="resizerH"></div>
            <div class="console" id="console"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        // Prevent Emscripten/sokol from capturing keyboard events when editor is focused
        // Must be registered BEFORE Emscripten loads
        (function() {
            const editorEl = document.getElementById('editor');

            function isEditorFocused() {
                return editorEl && editorEl.contains(document.activeElement);
            }

            // Intercept at window level before sokol can get it
            window.addEventListener('keydown', function(e) {
                if (isEditorFocused()) {
                    e.stopImmediatePropagation();
                }
            }, true);
            window.addEventListener('keyup', function(e) {
                if (isEditorFocused()) {
                    e.stopImmediatePropagation();
                }
            }, true);
            window.addEventListener('keypress', function(e) {
                if (isEditorFocused()) {
                    e.stopImmediatePropagation();
                }
            }, true);
        })();

        let editor;

        const defaultCode = `// Welcome to tcScript!
// Write C++-like code and click Run to see it in action.

global hue = 0.0

def setup() {
    print("Hello from tcScript!")
}

def update() {
    hue = hue + 0.005
    if (hue > 1.0) { hue = 0.0 }
}

def draw() {
    clear(1.0)

    // Draw rotating circles
    for (var i = 0; i < 8; ++i) {
        var angle = TAU * i / 8.0 + getElapsedTime()
        var x = getWindowWidth() / 2.0 + cos(angle) * 120.0
        var y = getWindowHeight() / 2.0 + sin(angle) * 120.0

        var h = fmod(hue + i * 0.125, 1.0)
        setColor(h, 0.7, 0.9)
        drawCircle(x, y, 25.0)
    }

    // Mouse follower
    setColor(0.2, 0.2, 0.2)
    drawCircle(getMouseX(), getMouseY(), 15.0)

    // FPS display
    setColor(0.4, 0.4, 0.4)
    drawText("FPS: " + to_string(getFrameRate()), 10.0, 20.0)
}

def mousePressed(x, y, button) {
    print("Click at " + to_string(x) + ", " + to_string(y))
}
`;

        // Load code from URL hash
        function loadFromHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#code=')) {
                try {
                    const encoded = hash.substring(6);
                    const code = decodeURIComponent(escape(atob(encoded)));
                    return code;
                } catch (e) {
                    console.error('Failed to decode URL:', e);
                }
            }
            return null;
        }

        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            // Define tcScript language (similar to C++)
            monaco.languages.register({ id: 'tcscript' });
            monaco.languages.setMonarchTokensProvider('tcscript', {
                keywords: ['def', 'var', 'global', 'if', 'else', 'for', 'while', 'return', 'true', 'false'],
                typeKeywords: ['int', 'float', 'string', 'bool'],
                operators: ['+', '-', '*', '/', '%', '=', '==', '!=', '<', '>', '<=', '>=', '&&', '||', '!'],
                symbols: /[=><!~?:&|+\-*\/\^%]+/,
                tokenizer: {
                    root: [
                        [/[a-zA-Z_]\w*/, { cases: { '@keywords': 'keyword', '@typeKeywords': 'type', '@default': 'identifier' } }],
                        [/[0-9]+\.?[0-9]*/, 'number'],
                        [/"[^"]*"/, 'string'],
                        [/\/\/.*$/, 'comment'],
                        [/[{}()\[\]]/, '@brackets'],
                        [/@symbols/, { cases: { '@operators': 'operator', '@default': '' } }],
                    ]
                }
            });

            monaco.editor.defineTheme('tcscript-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'keyword', foreground: 'c586c0' },
                    { token: 'identifier', foreground: '9cdcfe' },
                    { token: 'number', foreground: 'b5cea8' },
                    { token: 'string', foreground: 'ce9178' },
                    { token: 'comment', foreground: '6a9955' },
                ],
                colors: {
                    'editor.background': '#1e1e1e',
                }
            });

            // Check for code in URL hash
            const hashCode = loadFromHash();
            const initialCode = hashCode || defaultCode;

            editor = monaco.editor.create(document.getElementById('editor'), {
                value: initialCode,
                language: 'tcscript',
                theme: 'tcscript-dark',
                fontSize: 14,
                fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                automaticLayout: true,
                tabSize: 4,
            });

        });

        // Console logging
        function logToConsole(message, type = 'normal') {
            const consoleEl = document.getElementById('console');
            const line = document.createElement('div');
            line.className = 'console-line ' + type;
            line.textContent = message;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        function setStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        // Run script
        function runScript() {
            if (!Module || !Module.ccall) {
                logToConsole('Engine not ready yet!', 'error');
                return;
            }

            const code = editor.getValue();
            clearConsole();
            logToConsole('Running script...', 'notice');

            try {
                Module.ccall('updateScriptCode', null, ['string'], [code]);
                logToConsole('Script loaded successfully!', 'success');
            } catch (e) {
                logToConsole('Error: ' + e.message, 'error');
            }
        }

        // Save script to file
        async function saveScript() {
            const code = editor.getValue();

            // Use File System Access API if available
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: 'script.tc',
                        types: [{
                            description: 'tcScript Files',
                            accept: { 'text/plain': ['.tc'] }
                        }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(code);
                    await writable.close();
                    logToConsole('Script saved: ' + handle.name, 'success');
                    return;
                } catch (e) {
                    if (e.name === 'AbortError') return; // User cancelled
                }
            }

            // Fallback for browsers without File System Access API
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'script.tc';
            a.click();
            URL.revokeObjectURL(url);
            logToConsole('Script saved to file!', 'success');
        }

        // Load script from file
        function loadScript() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.tc,.txt';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        editor.setValue(e.target.result);
                        logToConsole('Script loaded from file: ' + file.name, 'success');
                        runScript();
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Share script via URL
        function shareScript() {
            const code = editor.getValue();
            const encoded = btoa(unescape(encodeURIComponent(code)));
            const url = window.location.origin + window.location.pathname + '#code=' + encoded;
            navigator.clipboard.writeText(url).then(() => {
                logToConsole('Share URL copied to clipboard!', 'success');
            }).catch(() => {
                logToConsole('Share URL: ' + url, 'notice');
            });
        }

        // Toggle fullscreen for canvas
        function toggleFullscreen() {
            const canvas = document.getElementById('canvas');
            if (!document.fullscreenElement) {
                canvas.requestFullscreen().catch(err => {
                    logToConsole('Fullscreen error: ' + err.message, 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Initialize Emscripten Module
        var Module = {
            canvas: (function() {
                return document.getElementById('canvas');
            })(),
            // Only capture keyboard events on the canvas, not globally
            keyboardListeningElement: document.getElementById('canvas'),
            onRuntimeInitialized: function() {
                document.getElementById('loading').style.display = 'none';
                const canvas = document.getElementById('canvas');
                canvas.style.display = 'block';
                // Immediately resize to prevent 2x flash
                resizeCanvas();
                requestAnimationFrame(resizeCanvas);
                setStatus('Ready', 'ready');
                logToConsole('tcScript engine ready!', 'success');
                // Auto-run script, then focus editor
                setTimeout(function() {
                    runScript();
                    if (editor) editor.focus();
                }, 100);
            },
            print: function(text) {
                logToConsole(text);
            },
            printErr: function(text) {
                // Filter out some noise
                if (text.includes('[NOTICE]')) {
                    logToConsole(text.replace(/\[.*?\]\s*\[NOTICE\]\s*/, ''), 'notice');
                } else if (text.includes('[ERROR]')) {
                    logToConsole(text.replace(/\[.*?\]\s*\[ERROR\]\s*/, ''), 'error');
                } else if (!text.includes('warning:')) {
                    logToConsole(text, 'error');
                }
            }
        };

        // Resize canvas to fit container while maintaining aspect ratio
        function resizeCanvas() {
            const canvas = document.getElementById('canvas');
            const container = document.getElementById('canvasContainer');
            if (!canvas || !container || canvas.style.display === 'none') return;

            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            const canvasRatio = 1; // 600x600 = 1:1

            let width, height;
            if (containerWidth / containerHeight > canvasRatio) {
                // Container is wider than canvas ratio
                height = containerHeight;
                width = height * canvasRatio;
            } else {
                // Container is taller than canvas ratio
                width = containerWidth;
                height = width / canvasRatio;
            }

            // Apply CSS size (not internal resolution)
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
        }

        // Call on load and resize
        window.addEventListener('resize', resizeCanvas);
        // Also call when resizers are used
        const originalResizeCanvas = resizeCanvas;
        setInterval(resizeCanvas, 500); // Fallback for resizer changes

        // Resizable panel dividers
        (function() {
            // Horizontal (left-right) resizer
            const resizer = document.getElementById('resizer');
            const editorPanel = document.getElementById('editorPanel');
            const canvasPanel = document.getElementById('canvasPanel');
            let isResizing = false;

            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                resizer.classList.add('active');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                const containerRect = document.querySelector('.main').getBoundingClientRect();
                const newEditorWidth = e.clientX - containerRect.left;
                const containerWidth = containerRect.width;

                // Limit resize range (20% - 80%)
                const minWidth = containerWidth * 0.2;
                const maxWidth = containerWidth * 0.8;

                if (newEditorWidth >= minWidth && newEditorWidth <= maxWidth) {
                    const editorPercent = (newEditorWidth / containerWidth) * 100;
                    editorPanel.style.width = editorPercent + '%';
                    canvasPanel.style.width = (100 - editorPercent) + '%';
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (isResizing) {
                    isResizing = false;
                    resizer.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });

            // Vertical (console height) resizer
            const resizerH = document.getElementById('resizerH');
            const consoleEl = document.getElementById('console');
            let isResizingH = false;

            resizerH.addEventListener('mousedown', function(e) {
                isResizingH = true;
                resizerH.classList.add('active');
                document.body.style.cursor = 'row-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizingH) return;

                const panelRect = canvasPanel.getBoundingClientRect();
                const newConsoleHeight = panelRect.bottom - e.clientY;

                // Limit resize range (60px - 400px)
                if (newConsoleHeight >= 60 && newConsoleHeight <= 400) {
                    consoleEl.style.height = newConsoleHeight + 'px';
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (isResizingH) {
                    isResizingH = false;
                    resizerH.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        })();
    </script>
    <script src="https://wasm.trussc.org/tcscript/tcScriptEngine.js"></script>
</body>
</html>
