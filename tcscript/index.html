<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tcScript - TrussC Playground</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #252526;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3c3c3c;
            height: 48px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 500;
            color: #cccccc;
        }

        .header h1 span {
            color: #569cd6;
        }

        .controls {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s;
        }

        .btn-run {
            background: #0e639c;
            color: white;
        }

        .btn-run:hover {
            background: #1177bb;
        }

        .btn-stop {
            background: #5a5a5a;
            color: white;
        }

        .btn-stop:hover {
            background: #6a6a6a;
        }

        .main {
            display: flex;
            height: calc(100vh - 48px);
        }

        .editor-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
        }

        #editor {
            flex: 1;
            width: 100%;
        }

        .canvas-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #canvas {
            outline: none;
        }

        #canvas:focus {
            outline: none;
        }

        .console {
            height: 240px;
            background: #1e1e1e;
            border-top: 1px solid #3c3c3c;
            overflow-y: auto;
            padding: 8px;
            font-size: 12px;
        }

        .resizer {
            width: 6px;
            background: #3c3c3c;
            cursor: col-resize;
            transition: background 0.2s;
        }

        .resizer:hover,
        .resizer.active {
            background: #007acc;
        }

        .resizer-h {
            height: 6px;
            background: #3c3c3c;
            cursor: row-resize;
            transition: background 0.2s;
        }

        .resizer-h:hover,
        .resizer-h.active {
            background: #007acc;
        }

        .console-line {
            margin: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .console-line.error {
            color: #f14c4c;
        }

        .console-line.notice {
            color: #3794ff;
        }

        .console-line.success {
            color: #89d185;
        }

        .status {
            padding: 4px 16px;
            background: #007acc;
            color: white;
            font-size: 12px;
        }

        .status.error {
            background: #f14c4c;
        }

        .status.ready {
            background: #89d185;
            color: #1e1e1e;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
        }

        .loading-spinner {
            border: 3px solid #3c3c3c;
            border-top: 3px solid #007acc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="header">
        <h1>tc<span>Script</span> - TrussC Playground</h1>
        <div class="controls">
            <button class="btn btn-run" id="runBtn" onclick="runScript()">Run</button>
            <button class="btn btn-stop" onclick="saveScript()">Save</button>
            <button class="btn btn-stop" onclick="loadScript()">Load</button>
            <button class="btn btn-stop" onclick="shareScript()">Share</button>
            <button class="btn btn-stop" onclick="toggleFullscreen()">Fullscreen</button>
            <a href="reference/" class="btn btn-stop" style="text-decoration:none;">Reference</a>
        </div>
    </div>

    <div class="main">
        <div class="editor-panel" id="editorPanel">
            <div id="editor"></div>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="canvas-panel" id="canvasPanel">
            <div class="status" id="status">Loading...</div>
            <div class="canvas-container" id="canvasContainer">
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading tcScript engine...</span>
                </div>
                <canvas id="canvas" tabindex="-1" style="display:none; width:600px; height:600px;"></canvas>
            </div>
            <div class="resizer-h" id="resizerH"></div>
            <div class="console" id="console"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        let editor;

        const defaultCode = `// Welcome to tcScript!
// Write C++-like code and click Run to see it in action.

global hue = 0.0

def setup() {
    logNotice("Hello from tcScript!")
}

def update() {
    hue = hue + 0.005
    if (hue > 1.0) { hue = 0.0 }
}

def draw() {
    clear(1.0)

    // Draw rotating circles
    for (var i = 0; i < 8; ++i) {
        var angle = TAU * i / 8.0 + getElapsedTime()
        var x = getWindowWidth() / 2.0 + cos(angle) * 120.0
        var y = getWindowHeight() / 2.0 + sin(angle) * 120.0

        var h = fmod(hue + i * 0.125, 1.0)
        setColor(h, 0.7, 0.9)
        drawCircle(x, y, 25.0)
    }

    // Mouse follower
    setColor(0.2, 0.2, 0.2)
    drawCircle(getMouseX(), getMouseY(), 15.0)

    // FPS display
    setColor(0.4, 0.4, 0.4)
    drawBitmapString("FPS: " + to_string(getFrameRate()), 10.0, 20.0)
}

def mousePressed(x, y, button) {
    logNotice("Click at " + to_string(x) + ", " + to_string(y))
}

def keyPressed(key) {
    logNotice("Key pressed: " + to_string(key))
}
`;

        // Load code from URL hash
        function loadFromHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#code=')) {
                try {
                    const encoded = hash.substring(6);
                    const code = decodeURIComponent(escape(atob(encoded)));
                    return code;
                } catch (e) {
                    console.error('Failed to decode URL:', e);
                }
            }
            return null;
        }

        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            // Define tcScript language (similar to C++)
            monaco.languages.register({ id: 'tcscript' });
            monaco.languages.setMonarchTokensProvider('tcscript', {
                keywords: ['def', 'var', 'global', 'if', 'else', 'for', 'while', 'return', 'true', 'false'],
                typeKeywords: ['int', 'float', 'string', 'bool'],
                operators: ['+', '-', '*', '/', '%', '=', '==', '!=', '<', '>', '<=', '>=', '&&', '||', '!'],
                symbols: /[=><!~?:&|+\-*\/\^%]+/,
                tokenizer: {
                    root: [
                        [/[a-zA-Z_]\w*/, { cases: { '@keywords': 'keyword', '@typeKeywords': 'type', '@default': 'identifier' } }],
                        [/[0-9]+\.?[0-9]*/, 'number'],
                        [/"[^"]*"/, 'string'],
                        [/\/\/.*$/, 'comment'],
                        [/[{}()\[\]]/, '@brackets'],
                        [/@symbols/, { cases: { '@operators': 'operator', '@default': '' } }],
                    ]
                }
            });

            monaco.editor.defineTheme('tcscript-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'keyword', foreground: 'c586c0' },
                    { token: 'identifier', foreground: '9cdcfe' },
                    { token: 'number', foreground: 'b5cea8' },
                    { token: 'string', foreground: 'ce9178' },
                    { token: 'comment', foreground: '6a9955' },
                ],
                colors: {
                    'editor.background': '#1e1e1e',
                }
            });

            // Register autocomplete provider
            const tcscriptCompletions = [
                // Lifecycle
                { label: 'setup', kind: monaco.languages.CompletionItemKind.Function, insertText: 'setup() {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Called once at start' },
                { label: 'update', kind: monaco.languages.CompletionItemKind.Function, insertText: 'update() {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Called every frame before draw' },
                { label: 'draw', kind: monaco.languages.CompletionItemKind.Function, insertText: 'draw() {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Called every frame after update' },
                // Events
                { label: 'mousePressed', kind: monaco.languages.CompletionItemKind.Function, insertText: 'mousePressed(x, y, button) {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Mouse button pressed' },
                { label: 'mouseReleased', kind: monaco.languages.CompletionItemKind.Function, insertText: 'mouseReleased(x, y, button) {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Mouse button released' },
                { label: 'mouseMoved', kind: monaco.languages.CompletionItemKind.Function, insertText: 'mouseMoved(x, y) {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Mouse moved' },
                { label: 'mouseDragged', kind: monaco.languages.CompletionItemKind.Function, insertText: 'mouseDragged(x, y, button) {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Mouse dragged' },
                { label: 'keyPressed', kind: monaco.languages.CompletionItemKind.Function, insertText: 'keyPressed(key) {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Key pressed' },
                { label: 'keyReleased', kind: monaco.languages.CompletionItemKind.Function, insertText: 'keyReleased(key) {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Key released' },
                { label: 'windowResized', kind: monaco.languages.CompletionItemKind.Function, insertText: 'windowResized(width, height) {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Window resized' },
                // Graphics - Color
                { label: 'clear', kind: monaco.languages.CompletionItemKind.Function, insertText: 'clear(${1:0.0})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Clear background' },
                { label: 'setColor', kind: monaco.languages.CompletionItemKind.Function, insertText: 'setColor(${1:1.0}, ${2:1.0}, ${3:1.0})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Set draw color (r, g, b)' },
                // Graphics - Shapes
                { label: 'drawRect', kind: monaco.languages.CompletionItemKind.Function, insertText: 'drawRect(${1:x}, ${2:y}, ${3:w}, ${4:h})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Draw rectangle' },
                { label: 'drawCircle', kind: monaco.languages.CompletionItemKind.Function, insertText: 'drawCircle(${1:x}, ${2:y}, ${3:radius})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Draw circle' },
                { label: 'drawEllipse', kind: monaco.languages.CompletionItemKind.Function, insertText: 'drawEllipse(${1:x}, ${2:y}, ${3:w}, ${4:h})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Draw ellipse' },
                { label: 'drawLine', kind: monaco.languages.CompletionItemKind.Function, insertText: 'drawLine(${1:x1}, ${2:y1}, ${3:x2}, ${4:y2})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Draw line' },
                { label: 'drawTriangle', kind: monaco.languages.CompletionItemKind.Function, insertText: 'drawTriangle(${1:x1}, ${2:y1}, ${3:x2}, ${4:y2}, ${5:x3}, ${6:y3})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Draw triangle' },
                { label: 'drawBitmapString', kind: monaco.languages.CompletionItemKind.Function, insertText: 'drawBitmapString(${1:"text"}, ${2:x}, ${3:y})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Draw text' },
                // Graphics - Style
                { label: 'fill', kind: monaco.languages.CompletionItemKind.Function, insertText: 'fill()', detail: 'Enable fill' },
                { label: 'noFill', kind: monaco.languages.CompletionItemKind.Function, insertText: 'noFill()', detail: 'Disable fill' },
                { label: 'stroke', kind: monaco.languages.CompletionItemKind.Function, insertText: 'stroke()', detail: 'Enable stroke' },
                { label: 'noStroke', kind: monaco.languages.CompletionItemKind.Function, insertText: 'noStroke()', detail: 'Disable stroke' },
                { label: 'setStrokeWeight', kind: monaco.languages.CompletionItemKind.Function, insertText: 'setStrokeWeight(${1:1.0})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Set stroke width' },
                // Transform
                { label: 'translate', kind: monaco.languages.CompletionItemKind.Function, insertText: 'translate(${1:x}, ${2:y})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Move origin' },
                { label: 'rotate', kind: monaco.languages.CompletionItemKind.Function, insertText: 'rotate(${1:radians})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Rotate by radians' },
                { label: 'rotateDeg', kind: monaco.languages.CompletionItemKind.Function, insertText: 'rotateDeg(${1:degrees})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Rotate by degrees' },
                { label: 'scale', kind: monaco.languages.CompletionItemKind.Function, insertText: 'scale(${1:s})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Scale' },
                { label: 'pushMatrix', kind: monaco.languages.CompletionItemKind.Function, insertText: 'pushMatrix()', detail: 'Save transform state' },
                { label: 'popMatrix', kind: monaco.languages.CompletionItemKind.Function, insertText: 'popMatrix()', detail: 'Restore transform state' },
                // Window & Input
                { label: 'getWindowWidth', kind: monaco.languages.CompletionItemKind.Function, insertText: 'getWindowWidth()', detail: 'Get canvas width' },
                { label: 'getWindowHeight', kind: monaco.languages.CompletionItemKind.Function, insertText: 'getWindowHeight()', detail: 'Get canvas height' },
                { label: 'getMouseX', kind: monaco.languages.CompletionItemKind.Function, insertText: 'getMouseX()', detail: 'Get mouse X position' },
                { label: 'getMouseY', kind: monaco.languages.CompletionItemKind.Function, insertText: 'getMouseY()', detail: 'Get mouse Y position' },
                { label: 'isMousePressed', kind: monaco.languages.CompletionItemKind.Function, insertText: 'isMousePressed()', detail: 'Is mouse button pressed' },
                // Time
                { label: 'getElapsedTime', kind: monaco.languages.CompletionItemKind.Function, insertText: 'getElapsedTime()', detail: 'Seconds since start' },
                { label: 'getDeltaTime', kind: monaco.languages.CompletionItemKind.Function, insertText: 'getDeltaTime()', detail: 'Seconds since last frame' },
                { label: 'getFrameRate', kind: monaco.languages.CompletionItemKind.Function, insertText: 'getFrameRate()', detail: 'Current FPS' },
                { label: 'getFrameCount', kind: monaco.languages.CompletionItemKind.Function, insertText: 'getFrameCount()', detail: 'Total frames rendered' },
                // Math
                { label: 'random', kind: monaco.languages.CompletionItemKind.Function, insertText: 'random(${1:min}, ${2:max})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Random float' },
                { label: 'noise', kind: monaco.languages.CompletionItemKind.Function, insertText: 'noise(${1:x})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Perlin noise' },
                { label: 'lerp', kind: monaco.languages.CompletionItemKind.Function, insertText: 'lerp(${1:a}, ${2:b}, ${3:t})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Linear interpolation' },
                { label: 'clamp', kind: monaco.languages.CompletionItemKind.Function, insertText: 'clamp(${1:v}, ${2:min}, ${3:max})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Clamp value to range' },
                { label: 'map', kind: monaco.languages.CompletionItemKind.Function, insertText: 'map(${1:v}, ${2:inMin}, ${3:inMax}, ${4:outMin}, ${5:outMax})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Map value between ranges' },
                { label: 'sin', kind: monaco.languages.CompletionItemKind.Function, insertText: 'sin(${1:x})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Sine' },
                { label: 'cos', kind: monaco.languages.CompletionItemKind.Function, insertText: 'cos(${1:x})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Cosine' },
                { label: 'tan', kind: monaco.languages.CompletionItemKind.Function, insertText: 'tan(${1:x})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Tangent' },
                { label: 'abs', kind: monaco.languages.CompletionItemKind.Function, insertText: 'abs(${1:x})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Absolute value' },
                { label: 'sqrt', kind: monaco.languages.CompletionItemKind.Function, insertText: 'sqrt(${1:x})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Square root' },
                { label: 'pow', kind: monaco.languages.CompletionItemKind.Function, insertText: 'pow(${1:x}, ${2:y})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Power (x^y)' },
                { label: 'min', kind: monaco.languages.CompletionItemKind.Function, insertText: 'min(${1:a}, ${2:b})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Minimum of two values' },
                { label: 'max', kind: monaco.languages.CompletionItemKind.Function, insertText: 'max(${1:a}, ${2:b})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Maximum of two values' },
                { label: 'floor', kind: monaco.languages.CompletionItemKind.Function, insertText: 'floor(${1:x})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Round down' },
                { label: 'ceil', kind: monaco.languages.CompletionItemKind.Function, insertText: 'ceil(${1:x})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Round up' },
                { label: 'fmod', kind: monaco.languages.CompletionItemKind.Function, insertText: 'fmod(${1:x}, ${2:y})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Floating-point modulo' },
                { label: 'deg2rad', kind: monaco.languages.CompletionItemKind.Function, insertText: 'deg2rad(${1:degrees})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Convert degrees to radians' },
                { label: 'rad2deg', kind: monaco.languages.CompletionItemKind.Function, insertText: 'rad2deg(${1:radians})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Convert radians to degrees' },
                // Utility
                { label: 'logNotice', kind: monaco.languages.CompletionItemKind.Function, insertText: 'logNotice(${1:"message"})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Print to console' },
                { label: 'to_string', kind: monaco.languages.CompletionItemKind.Function, insertText: 'to_string(${1:value})', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Convert to string' },
                // Constants
                { label: 'TAU', kind: monaco.languages.CompletionItemKind.Constant, insertText: 'TAU', detail: '6.283... (2*PI)' },
                { label: 'HALF_TAU', kind: monaco.languages.CompletionItemKind.Constant, insertText: 'HALF_TAU', detail: '3.141... (PI)' },
                { label: 'QUARTER_TAU', kind: monaco.languages.CompletionItemKind.Constant, insertText: 'QUARTER_TAU', detail: '1.570... (PI/2)' },
                { label: 'PI', kind: monaco.languages.CompletionItemKind.Constant, insertText: 'PI', detail: '3.141...' },
            ];

            monaco.languages.registerCompletionItemProvider('tcscript', {
                provideCompletionItems: function(model, position) {
                    const word = model.getWordUntilPosition(position);
                    const range = {
                        startLineNumber: position.lineNumber,
                        endLineNumber: position.lineNumber,
                        startColumn: word.startColumn,
                        endColumn: word.endColumn
                    };
                    return {
                        suggestions: tcscriptCompletions.map(item => ({
                            ...item,
                            range: range
                        }))
                    };
                }
            });

            // Check for code in URL hash
            const hashCode = loadFromHash();
            const initialCode = hashCode || defaultCode;

            editor = monaco.editor.create(document.getElementById('editor'), {
                value: initialCode,
                language: 'tcscript',
                theme: 'tcscript-dark',
                fontSize: 14,
                fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                automaticLayout: true,
                tabSize: 4,
                insertSpaces: true,
                detectIndentation: false,
            });

        });

        // Console logging
        function logToConsole(message, type = 'normal') {
            const consoleEl = document.getElementById('console');
            const line = document.createElement('div');
            line.className = 'console-line ' + type;
            line.textContent = message;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        function setStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        // Clear error markers from editor
        function clearErrorMarkers() {
            if (editor && monaco) {
                monaco.editor.setModelMarkers(editor.getModel(), 'tcscript', []);
            }
        }

        // Set error marker at specific line
        function setErrorMarker(line, column, message) {
            if (editor && monaco) {
                monaco.editor.setModelMarkers(editor.getModel(), 'tcscript', [{
                    startLineNumber: line,
                    startColumn: column,
                    endLineNumber: line,
                    endColumn: column + 10,
                    message: message,
                    severity: monaco.MarkerSeverity.Error
                }]);
            }
        }

        // Parse error message for line/column info
        function parseErrorLocation(errorMsg) {
            const match = errorMsg.match(/at \((\d+),\s*(\d+)\)/);
            if (match) {
                return { line: parseInt(match[1]), column: parseInt(match[2]) };
            }
            return null;
        }

        // Run script
        function runScript() {
            if (!editor) {
                logToConsole('Editor not ready yet!', 'error');
                return;
            }
            if (!Module || !Module.ccall) {
                logToConsole('Engine not ready yet!', 'error');
                return;
            }

            const code = editor.getValue();
            clearConsole();
            clearErrorMarkers();
            logToConsole('Running script...', 'notice');

            try {
                Module.ccall('updateScriptCode', null, ['string'], [code]);

                // Check for script errors
                const error = Module.ccall('getScriptError', 'string', [], []);
                if (error && error.length > 0) {
                    logToConsole('Error: ' + error, 'error');
                    const loc = parseErrorLocation(error);
                    if (loc) {
                        setErrorMarker(loc.line, loc.column, error);
                    }
                } else {
                    logToConsole('Script loaded successfully!', 'success');
                }
            } catch (e) {
                logToConsole('Error: ' + e.message, 'error');
            }
        }

        // Save script to file
        async function saveScript() {
            const code = editor.getValue();

            // Use File System Access API if available
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: 'script.tc',
                        types: [{
                            description: 'tcScript Files',
                            accept: { 'text/plain': ['.tc'] }
                        }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(code);
                    await writable.close();
                    logToConsole('Script saved: ' + handle.name, 'success');
                    return;
                } catch (e) {
                    if (e.name === 'AbortError') return; // User cancelled
                }
            }

            // Fallback for browsers without File System Access API
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'script.tc';
            a.click();
            URL.revokeObjectURL(url);
            logToConsole('Script saved to file!', 'success');
        }

        // Load script from file
        function loadScript() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.tc,.txt';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        editor.setValue(e.target.result);
                        logToConsole('Script loaded from file: ' + file.name, 'success');
                        runScript();
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Share script via URL
        function shareScript() {
            const code = editor.getValue();
            const encoded = btoa(unescape(encodeURIComponent(code)));
            const url = window.location.origin + window.location.pathname + '#code=' + encoded;
            navigator.clipboard.writeText(url).then(() => {
                logToConsole('Share URL copied to clipboard!', 'success');
            }).catch(() => {
                logToConsole('Share URL: ' + url, 'notice');
            });
        }

        // Toggle fullscreen for canvas
        function toggleFullscreen() {
            const canvas = document.getElementById('canvas');
            if (!document.fullscreenElement) {
                canvas.requestFullscreen().catch(err => {
                    logToConsole('Fullscreen error: ' + err.message, 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Initialize Emscripten Module
        var Module = {
            canvas: (function() {
                return document.getElementById('canvas');
            })(),
            // Required for direct character input to work properly
            keyboardListeningElement: document.getElementById('canvas'),
            onRuntimeInitialized: function() {
                document.getElementById('loading').style.display = 'none';
                const canvas = document.getElementById('canvas');
                canvas.style.display = 'block';
                // Immediately resize to prevent 2x flash
                resizeCanvas();
                requestAnimationFrame(resizeCanvas);
                setStatus('Ready', 'ready');
                logToConsole('tcScript engine ready!', 'success');
                // Focus canvas when clicked (required for keyboard input)
                canvas.addEventListener('mousedown', () => canvas.focus());
                // Auto-run script, then focus editor
                setTimeout(function() {
                    runScript();
                    if (editor) editor.focus();
                }, 100);
            },
            print: function(text) {
                logToConsole(text);
            },
            printErr: function(text) {
                // Filter out some noise
                if (text.includes('[NOTICE]')) {
                    logToConsole(text.replace(/\[.*?\]\s*\[NOTICE\]\s*/, ''), 'notice');
                } else if (text.includes('[ERROR]')) {
                    logToConsole(text.replace(/\[.*?\]\s*\[ERROR\]\s*/, ''), 'error');
                } else if (!text.includes('warning:')) {
                    logToConsole(text, 'error');
                }
            }
        };

        // Resize canvas to fit container while maintaining aspect ratio
        function resizeCanvas() {
            const canvas = document.getElementById('canvas');
            const container = document.getElementById('canvasContainer');
            if (!canvas || !container || canvas.style.display === 'none') return;

            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            const canvasRatio = 1; // 600x600 = 1:1

            let width, height;
            if (containerWidth / containerHeight > canvasRatio) {
                // Container is wider than canvas ratio
                height = containerHeight;
                width = height * canvasRatio;
            } else {
                // Container is taller than canvas ratio
                width = containerWidth;
                height = width / canvasRatio;
            }

            // Apply CSS size (not internal resolution)
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
        }

        // Call on load and resize
        window.addEventListener('resize', resizeCanvas);
        // Also call when resizers are used
        const originalResizeCanvas = resizeCanvas;
        setInterval(resizeCanvas, 500); // Fallback for resizer changes

        // Resizable panel dividers
        (function() {
            // Horizontal (left-right) resizer
            const resizer = document.getElementById('resizer');
            const editorPanel = document.getElementById('editorPanel');
            const canvasPanel = document.getElementById('canvasPanel');
            let isResizing = false;

            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                resizer.classList.add('active');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                const containerRect = document.querySelector('.main').getBoundingClientRect();
                const newEditorWidth = e.clientX - containerRect.left;
                const containerWidth = containerRect.width;

                // Limit resize range (20% - 80%)
                const minWidth = containerWidth * 0.2;
                const maxWidth = containerWidth * 0.8;

                if (newEditorWidth >= minWidth && newEditorWidth <= maxWidth) {
                    const editorPercent = (newEditorWidth / containerWidth) * 100;
                    editorPanel.style.width = editorPercent + '%';
                    canvasPanel.style.width = (100 - editorPercent) + '%';
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (isResizing) {
                    isResizing = false;
                    resizer.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });

            // Vertical (console height) resizer
            const resizerH = document.getElementById('resizerH');
            const consoleEl = document.getElementById('console');
            let isResizingH = false;

            resizerH.addEventListener('mousedown', function(e) {
                isResizingH = true;
                resizerH.classList.add('active');
                document.body.style.cursor = 'row-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizingH) return;

                const panelRect = canvasPanel.getBoundingClientRect();
                const newConsoleHeight = panelRect.bottom - e.clientY;

                // Limit resize range (60px - 400px)
                if (newConsoleHeight >= 60 && newConsoleHeight <= 400) {
                    consoleEl.style.height = newConsoleHeight + 'px';
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (isResizingH) {
                    isResizingH = false;
                    resizerH.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        })();
    </script>
    <script src="https://wasm.trussc.org/tcscript/tcScriptEngine.js"></script>
</body>
</html>
