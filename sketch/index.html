<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrussSketch - TrussC Playground</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #252526;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3c3c3c;
            height: 48px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 500;
            color: #cccccc;
        }

        .header h1 span {
            color: #569cd6;
        }

        .controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .controls-spacer {
            width: 16px;
        }

        /* Icon buttons (play, stop, fullscreen) */
        .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.1s;
        }

        .btn-icon:hover {
            transform: scale(1.05);
        }

        .btn-icon:active {
            transform: scale(0.95);
        }

        .btn-icon svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        .btn-play svg {
            width: 20px;
            height: 20px;
        }

        /* Stopped state (default) */
        .btn-play {
            background: #6e7681;
        }

        .btn-play:hover {
            background: #848d97;
        }

        .btn-stop-icon {
            background: #9e4a4a;
        }

        .btn-stop-icon:hover {
            background: #b35a5a;
        }

        /* Running state */
        .btn-play.running {
            background: #2ea043;
        }

        .btn-play.running:hover {
            background: #3fb950;
        }

        .btn-stop-icon.running {
            background: #6e7681;
        }

        .btn-stop-icon.running:hover {
            background: #848d97;
        }

        .btn-fullscreen {
            background: #6e7681;
        }

        .btn-fullscreen:hover {
            background: #848d97;
        }

        /* Text buttons (save, load, share, help) */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s;
            background: #3c3c3c;
            color: #cccccc;
        }

        .btn:hover {
            background: #4a4a4a;
        }

        .btn-help {
            padding: 6px 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .main {
            display: flex;
            height: calc(100vh - 48px);
        }

        .editor-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
        }

        #editor {
            flex: 1;
            width: 100%;
        }

        .canvas-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #canvas {
            outline: none;
        }

        #canvas:focus {
            outline: none;
        }

        .console {
            height: 240px;
            background: #1e1e1e;
            border-top: 1px solid #3c3c3c;
            overflow-y: auto;
            padding: 8px;
            font-size: 12px;
        }

        .resizer {
            width: 6px;
            background: #3c3c3c;
            cursor: col-resize;
            transition: background 0.2s;
        }

        .resizer:hover,
        .resizer.active {
            background: #007acc;
        }

        .resizer-h {
            height: 6px;
            background: #3c3c3c;
            cursor: row-resize;
            transition: background 0.2s;
        }

        .resizer-h:hover,
        .resizer-h.active {
            background: #007acc;
        }

        .console-line {
            margin: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .console-line.error {
            color: #f14c4c;
        }

        .console-line.notice {
            color: #3794ff;
        }

        .console-line.success {
            color: #89d185;
        }

        .status {
            padding: 4px 16px;
            background: #007acc;
            color: white;
            font-size: 12px;
        }

        .status.error {
            background: #f14c4c;
        }

        .status.ready {
            background: #89d185;
            color: #1e1e1e;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
        }

        .loading-spinner {
            border: 3px solid #3c3c3c;
            border-top: 3px solid #007acc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="header">
        <h1>Truss<span>Sketch</span></h1>
        <div class="controls">
            <!-- Playback controls -->
            <button class="btn-icon btn-play" id="runBtn" onclick="runScript()" title="Run">
                <svg viewBox="0 0 24 24"><polygon points="7,4 20,12 7,20" transform="translate(0.7,0)"/></svg>
            </button>
            <button class="btn-icon btn-stop-icon" id="stopBtn" onclick="stopScript()" title="Stop">
                <svg viewBox="0 0 24 24"><rect x="5" y="5" width="14" height="14" rx="2"/></svg>
            </button>
            <button class="btn-icon btn-fullscreen" onclick="toggleFullscreen()" title="Fullscreen">
                <svg viewBox="0 0 24 24"><path d="M2 2h7v2H4v5H2V2zm13 0h7v7h-2V4h-5V2zM2 15h2v5h5v2H2v-7zm18 0h2v7h-7v-2h5v-5z"/></svg>
            </button>
            <div class="controls-spacer"></div>
            <!-- File controls -->
            <button class="btn" onclick="saveScript()">Save</button>
            <button class="btn" onclick="loadScript()">Load</button>
            <button class="btn" id="shareBtn" onclick="shareScript()">Share</button>
            <a href="reference/" class="btn btn-help" style="text-decoration:none;" title="API Reference">?</a>
        </div>
    </div>

    <div class="main">
        <div class="editor-panel" id="editorPanel">
            <div id="editor"></div>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="canvas-panel" id="canvasPanel">
            <div class="status" id="status">Loading...</div>
            <div class="canvas-container" id="canvasContainer">
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading TrussSketch engine...</span>
                </div>
                <canvas id="canvas" tabindex="-1" style="display:none; width:600px; height:600px;"></canvas>
            </div>
            <div class="resizer-h" id="resizerH"></div>
            <div class="console" id="console"></div>
        </div>
    </div>

    <script src="trusssketch-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        let editor;
        let isModified = false;
        let savedContent = '';

        // Warn before leaving if there are unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (isModified) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        const defaultCode = `// Welcome to TrussSketch!
// Write C++-like code and click Run to see it in action.

global hue = 0.0
global time = 0.0

def setup() {
    logNotice("Hello from TrussSketch!")
}

def update() {
    time = time + getDeltaTime()
    hue = hue + 0.005
    if (hue > 1.0) { hue = 0.0 }
}

def draw() {
    clear(1.0)

    // Draw rotating circles
    for (var i = 0; i < 8; ++i) {
        var angle = TAU * i / 8.0 + time
        var x = getWindowWidth() / 2.0 + cos(angle) * 120.0
        var y = getWindowHeight() / 2.0 + sin(angle) * 120.0

        var h = fmod(hue + i * 0.125, 1.0)
        setColor(h, 0.7, 0.9)
        drawCircle(x, y, 25.0)
    }

    // Mouse follower
    setColor(0.2, 0.2, 0.2)
    drawCircle(getMouseX(), getMouseY(), 15.0)

    // FPS display
    setColor(0.4, 0.4, 0.4)
    drawBitmapString("FPS: " + to_string(getFrameRate()), 10.0, 20.0)
}

def mousePressed(x, y, button) {
    logNotice("Click at " + to_string(x) + ", " + to_string(y))
}

def keyPressed(key) {
    logNotice("Key pressed: " + to_string(key))
}
`;

        // Load code from URL hash (LZString compressed)
        function loadFromHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#')) {
                try {
                    const compressed = hash.substring(1);
                    const code = LZString.decompressFromEncodedURIComponent(compressed);
                    if (code) return code;
                } catch (e) {
                    console.error('Failed to decode URL:', e);
                }
            }
            return null;
        }

        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            // Define TrussSketch language (similar to C++)
            monaco.languages.register({ id: 'trusssketch' });
            monaco.languages.setMonarchTokensProvider('trusssketch', {
                keywords: ['def', 'var', 'global', 'if', 'else', 'for', 'while', 'return', 'true', 'false'],
                typeKeywords: ['int', 'float', 'string', 'bool'],
                operators: ['+', '-', '*', '/', '%', '=', '==', '!=', '<', '>', '<=', '>=', '&&', '||', '!'],
                symbols: /[=><!~?:&|+\-*\/\^%]+/,
                tokenizer: {
                    root: [
                        [/[a-zA-Z_]\w*/, { cases: { '@keywords': 'keyword', '@typeKeywords': 'type', '@default': 'identifier' } }],
                        [/[0-9]+\.?[0-9]*/, 'number'],
                        [/"[^"]*"/, 'string'],
                        [/\/\/.*$/, 'comment'],
                        [/[{}()\[\]]/, '@brackets'],
                        [/@symbols/, { cases: { '@operators': 'operator', '@default': '' } }],
                    ]
                }
            });

            monaco.editor.defineTheme('trusssketch-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'keyword', foreground: 'c586c0' },
                    { token: 'identifier', foreground: '9cdcfe' },
                    { token: 'number', foreground: 'b5cea8' },
                    { token: 'string', foreground: 'ce9178' },
                    { token: 'comment', foreground: '6a9955' },
                ],
                colors: {
                    'editor.background': '#1e1e1e',
                }
            });

            // Register autocomplete provider from trusssketch-api.js
            function buildCompletions() {
                const completions = [];

                // Add functions
                for (const cat of TrussSketchAPI.categories) {
                    for (const fn of cat.functions) {
                        completions.push({
                            label: fn.name,
                            kind: monaco.languages.CompletionItemKind.Function,
                            insertText: fn.snippet,
                            insertTextRules: fn.snippet.includes('$') ?
                                monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet : undefined,
                            detail: fn.desc
                        });
                    }
                }

                // Add constants
                for (const c of TrussSketchAPI.constants) {
                    completions.push({
                        label: c.name,
                        kind: monaco.languages.CompletionItemKind.Constant,
                        insertText: c.name,
                        detail: `${c.value} - ${c.desc}`
                    });
                }

                return completions;
            }

            const trusssketchCompletions = buildCompletions();

            monaco.languages.registerCompletionItemProvider('trusssketch', {
                provideCompletionItems: function(model, position) {
                    const word = model.getWordUntilPosition(position);
                    const range = {
                        startLineNumber: position.lineNumber,
                        endLineNumber: position.lineNumber,
                        startColumn: word.startColumn,
                        endColumn: word.endColumn
                    };
                    return {
                        suggestions: trusssketchCompletions.map(item => ({
                            ...item,
                            range: range
                        }))
                    };
                }
            });

            // Check for code in URL hash
            const hashCode = loadFromHash();
            const initialCode = hashCode || defaultCode;

            editor = monaco.editor.create(document.getElementById('editor'), {
                value: initialCode,
                language: 'trusssketch',
                theme: 'trusssketch-dark',
                fontSize: 14,
                fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                automaticLayout: true,
                tabSize: 4,
                insertSpaces: true,
                detectIndentation: false,
            });

            // Track changes for unsaved warning
            savedContent = initialCode;
            editor.onDidChangeModelContent(() => {
                isModified = editor.getValue() !== savedContent;
            });

        });

        // Console logging
        function logToConsole(message, type = 'normal') {
            const consoleEl = document.getElementById('console');
            const line = document.createElement('div');
            line.className = 'console-line ' + type;
            line.textContent = message;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        function setStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        // Clear error markers from editor
        function clearErrorMarkers() {
            if (editor && monaco) {
                monaco.editor.setModelMarkers(editor.getModel(), 'trusssketch', []);
            }
        }

        // Set error marker at specific line
        function setErrorMarker(line, column, message) {
            if (editor && monaco) {
                monaco.editor.setModelMarkers(editor.getModel(), 'trusssketch', [{
                    startLineNumber: line,
                    startColumn: column,
                    endLineNumber: line,
                    endColumn: column + 10,
                    message: message,
                    severity: monaco.MarkerSeverity.Error
                }]);
            }
        }

        // Parse error message for line/column info
        function parseErrorLocation(errorMsg) {
            const match = errorMsg.match(/at \((\d+),\s*(\d+)\)/);
            if (match) {
                return { line: parseInt(match[1]), column: parseInt(match[2]) };
            }
            return null;
        }

        // Run script
        function runScript() {
            if (!editor) {
                logToConsole('Editor not ready yet!', 'error');
                return;
            }
            if (!Module || !Module.ccall) {
                logToConsole('Engine not ready yet!', 'error');
                return;
            }

            const code = editor.getValue();
            clearConsole();
            clearErrorMarkers();
            logToConsole('Running script...', 'notice');

            try {
                // Resume engine if it was paused
                Module.ccall('resumeEngine', null, [], []);
                Module.ccall('updateScriptCode', null, ['string'], [code]);

                // Check for script errors
                const error = Module.ccall('getScriptError', 'string', [], []);
                if (error && error.length > 0) {
                    logToConsole('Error: ' + error, 'error');
                    const loc = parseErrorLocation(error);
                    if (loc) {
                        setErrorMarker(loc.line, loc.column, error);
                    }
                } else {
                    logToConsole('Script loaded successfully!', 'success');
                    // Set running state
                    document.getElementById('runBtn').classList.add('running');
                    document.getElementById('stopBtn').classList.add('running');
                }
            } catch (e) {
                logToConsole('Error: ' + e.message, 'error');
            }
        }

        // Stop script (pause engine for power saving)
        function stopScript() {
            if (!Module || !Module.ccall) {
                logToConsole('Engine not ready yet!', 'error');
                return;
            }

            try {
                Module.ccall('pauseEngine', null, [], []);
                clearErrorMarkers();
                logToConsole('Engine paused.', 'notice');
                // Clear running state
                document.getElementById('runBtn').classList.remove('running');
                document.getElementById('stopBtn').classList.remove('running');
            } catch (e) {
                logToConsole('Error: ' + e.message, 'error');
            }
        }

        // Save script to file
        async function saveScript() {
            const code = editor.getValue();

            // Use File System Access API if available
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: 'script.tcs',
                        types: [{
                            description: 'TrussSketch Files',
                            accept: { 'text/plain': ['.tcs'] }
                        }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(code);
                    await writable.close();
                    logToConsole('Script saved: ' + handle.name, 'success');
                    savedContent = code;
                    isModified = false;
                    return;
                } catch (e) {
                    if (e.name === 'AbortError') return; // User cancelled
                }
            }

            // Fallback for browsers without File System Access API
            // Use octet-stream to prevent iOS from adding .txt extension
            const blob = new Blob([code], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'script.tcs';
            a.click();
            URL.revokeObjectURL(url);
            logToConsole('Script saved to file!', 'success');
            savedContent = code;
            isModified = false;
        }

        // Load script from file
        function loadScript() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.tcs,.txt';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        editor.setValue(content);
                        savedContent = content;
                        isModified = false;
                        logToConsole('Script loaded from file: ' + file.name, 'success');
                        runScript();
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Share script via short URL (with fallback to long URL)
        async function shareScript() {
            const btn = document.getElementById('shareBtn');
            const originalText = btn.textContent;

            // Immediately show "Copied!" feedback
            btn.textContent = 'Copied!';
            btn.style.background = '#2ea043';

            // Revert after 2 seconds
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 2000);

            const code = editor.getValue();
            const compressed = LZString.compressToEncodedURIComponent(code);

            // Try to create short URL first
            try {
                const response = await fetch('/api/shorten', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: compressed })
                });

                if (response.ok) {
                    const { url } = await response.json();
                    await navigator.clipboard.writeText(url);
                    logToConsole('Short URL copied! ' + url, 'success');
                    return;
                } else {
                    logToConsole('Shortener API error: ' + response.status, 'error');
                }
            } catch (e) {
                logToConsole('Shortener error: ' + e.message, 'error');
            }

            // Fallback to long URL
            const url = window.location.origin + window.location.pathname + '#' + compressed;
            try {
                await navigator.clipboard.writeText(url);
                logToConsole('Long URL copied (' + compressed.length + ' chars)', 'success');
            } catch (e) {
                logToConsole('Share URL: ' + url, 'notice');
            }
        }

        // Toggle fullscreen for canvas
        function toggleFullscreen() {
            const canvas = document.getElementById('canvas');
            if (!document.fullscreenElement) {
                canvas.requestFullscreen().catch(err => {
                    logToConsole('Fullscreen error: ' + err.message, 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Initialize Emscripten Module
        var Module = {
            canvas: (function() {
                return document.getElementById('canvas');
            })(),
            // Required for direct character input to work properly
            keyboardListeningElement: document.getElementById('canvas'),
            onRuntimeInitialized: function() {
                document.getElementById('loading').style.display = 'none';
                const canvas = document.getElementById('canvas');
                canvas.style.display = 'block';
                // Immediately resize to prevent 2x flash
                resizeCanvas();
                requestAnimationFrame(resizeCanvas);
                setStatus('Ready', 'ready');
                logToConsole('TrussSketch engine ready!', 'success');
                // Focus canvas when clicked (required for keyboard input)
                canvas.addEventListener('mousedown', () => canvas.focus());
                // Auto-run script, then focus editor
                setTimeout(function() {
                    runScript();
                    if (editor) editor.focus();
                }, 100);
            },
            print: function(text) {
                logToConsole(text);
            },
            printErr: function(text) {
                // Filter out some noise
                if (text.includes('[NOTICE]')) {
                    logToConsole(text.replace(/\[.*?\]\s*\[NOTICE\]\s*/, ''), 'notice');
                } else if (text.includes('[ERROR]')) {
                    logToConsole(text.replace(/\[.*?\]\s*\[ERROR\]\s*/, ''), 'error');
                } else if (!text.includes('warning:')) {
                    logToConsole(text, 'error');
                }
            }
        };

        // Resize canvas to fit container while maintaining aspect ratio
        function resizeCanvas() {
            const canvas = document.getElementById('canvas');
            const container = document.getElementById('canvasContainer');
            if (!canvas || !container || canvas.style.display === 'none') return;

            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            const canvasRatio = 1; // 600x600 = 1:1

            let width, height;
            if (containerWidth / containerHeight > canvasRatio) {
                // Container is wider than canvas ratio
                height = containerHeight;
                width = height * canvasRatio;
            } else {
                // Container is taller than canvas ratio
                width = containerWidth;
                height = width / canvasRatio;
            }

            // Apply CSS size (not internal resolution)
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
        }

        // Call on load and resize
        window.addEventListener('resize', resizeCanvas);
        // Also call when resizers are used
        const originalResizeCanvas = resizeCanvas;
        setInterval(resizeCanvas, 500); // Fallback for resizer changes

        // Resizable panel dividers
        (function() {
            // Horizontal (left-right) resizer
            const resizer = document.getElementById('resizer');
            const editorPanel = document.getElementById('editorPanel');
            const canvasPanel = document.getElementById('canvasPanel');
            let isResizing = false;

            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                resizer.classList.add('active');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                const containerRect = document.querySelector('.main').getBoundingClientRect();
                const newEditorWidth = e.clientX - containerRect.left;
                const containerWidth = containerRect.width;

                // Limit resize range (20% - 80%)
                const minWidth = containerWidth * 0.2;
                const maxWidth = containerWidth * 0.8;

                if (newEditorWidth >= minWidth && newEditorWidth <= maxWidth) {
                    const editorPercent = (newEditorWidth / containerWidth) * 100;
                    editorPanel.style.width = editorPercent + '%';
                    canvasPanel.style.width = (100 - editorPercent) + '%';
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (isResizing) {
                    isResizing = false;
                    resizer.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });

            // Vertical (console height) resizer
            const resizerH = document.getElementById('resizerH');
            const consoleEl = document.getElementById('console');
            let isResizingH = false;

            resizerH.addEventListener('mousedown', function(e) {
                isResizingH = true;
                resizerH.classList.add('active');
                document.body.style.cursor = 'row-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizingH) return;

                const panelRect = canvasPanel.getBoundingClientRect();
                const newConsoleHeight = panelRect.bottom - e.clientY;

                // Limit resize range (60px - 400px)
                if (newConsoleHeight >= 60 && newConsoleHeight <= 400) {
                    consoleEl.style.height = newConsoleHeight + 'px';
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (isResizingH) {
                    isResizingH = false;
                    resizerH.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        })();
    </script>
    <script src="https://wasm.trussc.org/sketch/TrussSketch.js"></script>
</body>
</html>
